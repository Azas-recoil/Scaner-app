<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>EscÃ¡ner QR</title>
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: #f4f6f8;
    }
    #reader {
      width: 300px;
      margin: auto;
    }
    #estado {
      margin-top: 15px;
      font-size: 18px;
      font-weight: bold;
    }
    .ok { color: green; }
    .error { color: red; }
  </style>
</head>
<body>

<h2>Control de Acceso</h2>

<div id="reader"></div>
<div id="estado">Escanee el QR</div>

<script>
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbysbqsaZxbFc3upPXvNDrpjySdOX1D4I_POyn_5xgfr81descg7-KLBntaQ6GrFLYA7Dg/exec";

  // ðŸ”’ Bloqueo por QR individual
  let bloqueosQR = {}; // { qr: timestamp }

  function beep() {
    const ctx = new AudioContext();
    const osc = ctx.createOscillator();
    osc.type = "sine";
    osc.frequency.value = 800;
    osc.connect(ctx.destination);
    osc.start();
    setTimeout(() => {
      osc.stop();
      ctx.close();
    }, 150);
  }

  function mostrar(msg, ok = true) {
    const el = document.getElementById("estado");
    el.textContent = msg;
    el.className = ok ? "ok" : "error";
  }

  function onScanSuccess(qr) {
    const ahora = Date.now();

    // ðŸ”’ Bloqueo de 3 segundos por QR
    if (bloqueosQR[qr] && ahora - bloqueosQR[qr] < 3000) return;
    bloqueosQR[qr] = ahora;

    mostrar("Procesando...");

    fetch(`${WEB_APP_URL}?qr=${encodeURIComponent(qr)}&dispositivo=web`)
      .then(r => r.json())
      .then(data => {
        if (data.ok) {
          beep();
          mostrar(`${data.nombre} â€” ${data.tipo}`);
        } else {
          mostrar(data.mensaje || "Error", false);
        }
      })
      .catch(() => {
        mostrar("Error de conexiÃ³n", false);
      });

    // ðŸ”„ Limpiar bloqueo despuÃ©s de 3 segundos
    setTimeout(() => {
      delete bloqueosQR[qr];
      mostrar("Escanee el QR");
    }, 3000);
  }

  const scanner = new Html5QrcodeScanner(
    "reader",
    { fps: 10, qrbox: 250 }
  );
  scanner.render(onScanSuccess);
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Esc√°ner QR</title>
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    body { font-family: Arial; text-align: center; background: #f4f6f8; }
    #reader { width: 300px; margin: auto; }
    #estado { margin-top: 15px; font-size: 18px; font-weight: bold; }
    .ok { color: green; } .error { color: red; }
    button { margin: 5px; padding: 10px 20px; font-size: 16px; }
  </style>
</head>
<body>

<h2>Control de Acceso</h2>

<div>
  <button id="btnEntrada">Modo Entrada</button>
  <button id="btnSalida">Modo Salida</button>
</div>

<div id="reader"></div>
<div id="estado">Escanee el QR</div>

<script>
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzBxG5l6GGoaoefKsj9RVoknMbaUtWMprGr0uhVQqMJZdTin9ITSARG5LfVUR9MNOJGww/exec";

  let modoActual = "Entrada"; // default
  const bloqueosQR = {}; // { "QR-modo": timestamp }

  // üîò Botones de modo
  document.getElementById("btnEntrada").onclick = () => { modoActual = "Entrada"; mostrar("Modo Entrada"); };
  document.getElementById("btnSalida").onclick = () => { modoActual = "Salida"; mostrar("Modo Salida"); };

  function beep() {
    const ctx = new AudioContext();
    const osc = ctx.createOscillator();
    osc.type = "sine"; osc.frequency.value = 800;
    osc.connect(ctx.destination); osc.start();
    setTimeout(() => { osc.stop(); ctx.close(); }, 150);
  }

  function mostrar(msg, ok = true) {
    const el = document.getElementById("estado");
    el.textContent = msg;
    el.className = ok ? "ok" : "error";
  }

  function onScanSuccess(qr) {
    const ahora = Date.now();
    const key = qr + "-" + modoActual;

    if (bloqueosQR[key] && ahora - bloqueosQR[key] < 3000) return;
    bloqueosQR[key] = ahora;

    mostrar("Procesando...");

    fetch(`${WEB_APP_URL}?qr=${encodeURIComponent(qr)}&dispositivo=web&modo=${modoActual}`)
      .then(r => r.json())
      .then(data => {
        if (data.ok) {
          beep();
          mostrar(`${data.nombre} ‚Äî ${data.tipo}`);
        } else {
          mostrar(data.mensaje || "Error", false);
        }
      })
      .catch(() => { mostrar("Error de conexi√≥n", false); });

    setTimeout(() => { delete bloqueosQR[key]; mostrar("Escanee el QR"); }, 3000);
  }

  const scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
  scanner.render(onScanSuccess);
</script>

</body>
</html>

